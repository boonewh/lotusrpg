{% extends "base.html" %}
{% block content %}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<div class="min-h-screen flex items-center justify-center bg-gradient-to-b from-gray-900 via-gray-800 to-gray-900 p-6">
  <div class="w-full max-w-xl bg-gray-800 rounded-lg shadow-lg p-8 text-center text-white border border-indigo-600">
    <h1 class="text-4xl font-bold mb-4 tracking-wide"><i class="fas fa-dice-d20 text-indigo-400 mr-2"></i>L.O.T.U.S. Dice Roller</h1>

    <p class="text-gray-400 mb-6">Supports <code class="bg-gray-700 px-2 py-1 rounded">Xd10!</code> and <code class="bg-gray-700 px-2 py-1 rounded">1d10! + 1d6!</code> rolls.</p>

    <div class="flex justify-center gap-2 mb-6">
      <input type="text" id="dice-input" placeholder="e.g. 2d10!" value="2d10!" class="w-1/2 px-4 py-2 rounded-lg text-black shadow-inner focus:outline-none focus:ring-2 focus:ring-indigo-500" />
      <button onclick="rollAndDisplay()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg shadow-lg transition-all duration-150 ease-in-out animate-pulse">
        <i class="fas fa-dice fa-shake mr-2"></i>Roll
      </button>
    </div>

    <div id="result" class="mt-6 text-left text-lg"></div>
  </div>
</div>

<script>
function rollExplodingDie(sides) {
  let rolls = [];
  let result = Math.floor(Math.random() * sides) + 1;
  rolls.push(result);
  while (result === sides) {
    result = Math.floor(Math.random() * sides) + 1;
    rolls.push(result);
  }
  return rolls;
}

function rollDiceExpression(expression) {
  const regex = /(\d*)d(\d+)(!?)|[+]/g;
  const tokens = expression.match(regex);
  if (!tokens) return { total: 0, detail: [] };

  let total = 0;
  let detail = [];

  for (let i = 0; i < tokens.length; i++) {
    const token = tokens[i];
    if (token === '+') continue;

    const match = token.match(/(\d*)d(\d+)(!?)?/);
    if (match) {
      let count = parseInt(match[1]) || 1;
      let sides = parseInt(match[2]);
      let exploding = match[3] === '!';
      let diceResults = [];

      for (let j = 0; j < count; j++) {
        const rolls = exploding ? rollExplodingDie(sides) : [Math.floor(Math.random() * sides) + 1];
        const subtotal = rolls.reduce((a, b) => a + b, 0);
        total += subtotal;
        diceResults.push({ rolls, subtotal });
      }

      detail.push({ token, diceResults });
    }
  }

  return { total, detail };
}

function rollAndDisplay() {
  const input = document.getElementById('dice-input').value;
  const { total, detail } = rollDiceExpression(input);

  let output = `<div class="bg-gray-900 p-4 rounded-lg border border-indigo-500 shadow-md"><p class="text-2xl font-bold mb-2 text-indigo-300">ðŸŽ¯ Total: <span class="text-white">${total}</span></p><ul class="list-disc list-inside text-sm text-gray-300">`;

  for (let group of detail) {
    for (let d of group.diceResults) {
      const exploded = d.rolls.length > 1 ? ' <span class="text-pink-400 font-semibold">(exploded!)</span>' : '';
      output += `<li><i class="fas fa-dice text-indigo-400 mr-1"></i><span class="font-semibold">${group.token}:</span> ${d.rolls.join(' + ')} = <span class="text-white font-bold">${d.subtotal}</span>${exploded}</li>`;
    }
  }

  output += '</ul></div>';
  document.getElementById('result').innerHTML = output;
}
</script>
{% endblock %}
